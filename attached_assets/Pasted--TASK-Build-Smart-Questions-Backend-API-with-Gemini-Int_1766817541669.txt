## TASK: Build Smart Questions Backend API with Gemini Integration

### OVERVIEW
Create the API endpoints for generating personalized interview questions using Gemini 2.5 Pro.

### STEP 1: Install Google AI SDK

pip install google-generativeai

### STEP 2: Create Smart Questions Router

Create file: backend/routers/smart_questions.py

from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel
from typing import Optional, List
import google.generativeai as genai
import json
import os
from datetime import datetime

router = APIRouter(prefix="/api/smart-questions", tags=["smart-questions"])

# Configure Gemini
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))

class GenerateRequest(BaseModel):
    xray_analysis_id: Optional[str] = None
    job_description: Optional[str] = None
    cv_text: Optional[str] = None

class EligibilityResponse(BaseModel):
    eligible: bool
    reason: str
    free_trial_used: bool

@router.get("/check-eligibility")
async def check_eligibility(user_id: str):
    """Check if user can use Smart Questions (free trial or paid)"""
    # Query database for user's free trial status
    # For now, check if smart_questions_free_used is False
    
    user = await get_user(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    
    free_used = user.get("smart_questions_free_used", False)
    
    # TODO: Also check if user has paid subscription
    is_paid = False  # Placeholder for payment check
    
    if is_paid:
        return {"eligible": True, "reason": "paid_user", "free_trial_used": free_used}
    elif not free_used:
        return {"eligible": True, "reason": "free_trial", "free_trial_used": False}
    else:
        return {"eligible": False, "reason": "free_trial_exhausted", "free_trial_used": True}

@router.post("/generate")
async def generate_smart_questions(request: GenerateRequest, user_id: str):
    """Generate personalized interview questions using Gemini"""
    
    # 1. Check eligibility
    eligibility = await check_eligibility(user_id)
    if not eligibility["eligible"]:
        raise HTTPException(status_code=403, detail="Free trial exhausted. Please upgrade.")
    
    # 2. Get X-Ray data if xray_analysis_id provided
    xray_data = None
    job_title = "Unknown Position"
    company_name = None
    
    if request.xray_analysis_id:
        xray_analysis = await get_xray_analysis(request.xray_analysis_id)
        if xray_analysis:
            xray_data = xray_analysis.get("structured_output") or xray_analysis.get("report_markdown")
            job_title = xray_analysis.get("job_title", "Unknown Position")
            company_name = xray_analysis.get("company_name")
    
    # 3. If no X-Ray but job_description provided, use that
    if not xray_data and request.job_description:
        xray_data = request.job_description
        # Try to extract job title from first line
        first_line = request.job_description.split('\n')[0]
        if len(first_line) < 100:
            job_title = first_line
    
    if not xray_data:
        raise HTTPException(status_code=400, detail="Either xray_analysis_id or job_description required")
    
    # 4. Build prompt and call Gemini
    prompt = build_smart_questions_prompt(xray_data, request.cv_text)
    
    model = genai.GenerativeModel('gemini-2.5-pro-preview-05-06')
    response = model.generate_content(prompt)
    
    # 5. Parse response
    try:
        result = parse_gemini_response(response.text)
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Failed to parse AI response: {str(e)}")
    
    # 6. Save to database
    record = {
        "user_id": user_id,
        "xray_analysis_id": request.xray_analysis_id,
        "job_title": job_title,
        "company_name": company_name,
        "cv_provided": bool(request.cv_text),
        "weak_areas": result.get("weak_areas", []),
        "personalized_questions": result.get("questions", []),
        "generation_model": "gemini-2.5-pro",
        "input_tokens": response.usage_metadata.prompt_token_count if hasattr(response, 'usage_metadata') else None,
        "output_tokens": response.usage_metadata.candidates_token_count if hasattr(response, 'usage_metadata') else None
    }
    
    saved = await save_smart_questions_result(record)
    
    # 7. Mark free trial as used (if this was free trial)
    if eligibility["reason"] == "free_trial":
        await mark_free_trial_used(user_id)
    
    return {
        "id": saved["id"],
        "job_title": job_title,
        "company_name": company_name,
        "weak_areas": result.get("weak_areas", []),
        "questions_count": len(result.get("questions", [])),
        "message": "Smart questions generated successfully"
    }

@router.get("/{result_id}")
async def get_smart_questions_result(result_id: str, user_id: str):
    """Get a specific smart questions result"""
    result = await get_smart_questions_by_id(result_id)
    
    if not result:
        raise HTTPException(status_code=404, detail="Result not found")
    
    if result["user_id"] != user_id:
        raise HTTPException(status_code=403, detail="Access denied")
    
    return result

### STEP 3: Add Router to Main App

In main.py, add:
from routers.smart_questions import router as smart_questions_router
app.include_router(smart_questions_router)

### STEP 4: Add GEMINI_API_KEY to Environment

Add to .env or Replit Secrets:
GEMINI_API_KEY=your_gemini_api_key_here

### SUCCESS CHECKLIST
- [ ] GET /api/smart-questions/check-eligibility works
- [ ] POST /api/smart-questions/generate works
- [ ] GET /api/smart-questions/{id} works
- [ ] Gemini API integration works
- [ ] Free trial tracking works
- [ ] Results saved to database