## TASK: Create Smart Questions Database Schema

### OVERVIEW
Create the database table to store AI-generated personalized interview questions and track free tier usage.

### STEP 1: Create smart_question_results Table

Run this SQL in Supabase:

CREATE TABLE smart_question_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    xray_analysis_id UUID REFERENCES xray_analyses(id) ON DELETE SET NULL,
    job_title TEXT NOT NULL,
    company_name TEXT,
    cv_provided BOOLEAN DEFAULT FALSE,
    weak_areas JSONB,
    personalized_questions JSONB,
    generation_model TEXT DEFAULT 'gemini-2.5-pro',
    input_tokens INTEGER,
    output_tokens INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX idx_smart_questions_user_id ON smart_question_results(user_id);
CREATE INDEX idx_smart_questions_created_at ON smart_question_results(created_at DESC);

-- Enable RLS
ALTER TABLE smart_question_results ENABLE ROW LEVEL SECURITY;

-- Users can only see their own results
CREATE POLICY "Users can view own smart questions" 
    ON smart_question_results FOR SELECT 
    USING (auth.uid()::text = user_id::text OR user_id IN (SELECT id FROM users WHERE email = current_user));

CREATE POLICY "Users can insert own smart questions" 
    ON smart_question_results FOR INSERT 
    WITH CHECK (true);

### STEP 2: Add Free Trial Tracking to Users Table

ALTER TABLE users ADD COLUMN IF NOT EXISTS smart_questions_free_used BOOLEAN DEFAULT FALSE;

### STEP 3: JSONB Structure Documentation

The weak_areas JSONB should store:
[
    {
        "area": "Leadership Experience",
        "risk_level": "high",
        "detection_reason": "CV shows individual contributor roles only",
        "preparation_tip": "Prepare examples of informal leadership..."
    }
]

The personalized_questions JSONB should store:
[
    {
        "category": "behavioral",
        "question_text": "Tell me about a time you led a project",
        "personalized_context": "Based on your PM background at TechCorp...",
        "why_they_ask": "Testing leadership experience",
        "good_answer_example": "...",
        "what_to_avoid": "...",
        "source": "cv_gap"
    }
]

### SUCCESS CHECKLIST
- [ ] smart_question_results table created
- [ ] users table has smart_questions_free_used column
- [ ] Indexes created for user_id and created_at
- [ ] RLS policies enabled