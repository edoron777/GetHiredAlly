## TASK: Add "Cost by User" Section to AI Usage Admin Dashboard

### OVERVIEW
Add a new section to the admin dashboard showing AI usage costs broken down by user.

### STEP 1: Update Backend API

In backend/routers/admin.py, add new endpoint:

@router.get("/ai-usage/by-user")
async def get_usage_by_user(
    user_id: str,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    limit: int = 20
):
    """Get AI usage breakdown by user"""
    await verify_admin(user_id)
    
    # Default to last 30 days
    if not end_date:
        end_date = date.today()
    if not start_date:
        start_date = end_date - timedelta(days=30)
    
    # Query usage grouped by user
    result = supabase.table('ai_usage_logs').select(
        'user_id, users(email)',
        count='exact'
    ).gte('created_at', start_date.isoformat()).lte('created_at', end_date.isoformat()).execute()
    
    # Alternative: Use raw SQL for aggregation
    query = """
    SELECT 
        l.user_id,
        u.email,
        COUNT(*) as total_requests,
        SUM(l.cost_usd) as total_cost,
        SUM(l.input_tokens) as total_input_tokens,
        SUM(l.output_tokens) as total_output_tokens,
        MAX(l.created_at) as last_used
    FROM ai_usage_logs l
    LEFT JOIN users u ON l.user_id = u.id
    WHERE l.created_at >= %s AND l.created_at <= %s
    GROUP BY l.user_id, u.email
    ORDER BY total_cost DESC
    LIMIT %s
    """
    
    result = supabase.rpc('get_usage_by_user', {
        'start_date': start_date.isoformat(),
        'end_date': end_date.isoformat(),
        'limit_count': limit
    }).execute()
    
    return result.data or []

### STEP 2: Create SQL Function in Supabase

Run this in Supabase SQL Editor:

CREATE OR REPLACE FUNCTION get_usage_by_user(
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    limit_count INTEGER DEFAULT 20
)
RETURNS TABLE (
    user_id UUID,
    email TEXT,
    total_requests BIGINT,
    total_cost DECIMAL,
    total_input_tokens BIGINT,
    total_output_tokens BIGINT,
    last_used TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        l.user_id,
        u.email,
        COUNT(*)::BIGINT as total_requests,
        COALESCE(SUM(l.cost_usd), 0)::DECIMAL as total_cost,
        COALESCE(SUM(l.input_tokens), 0)::BIGINT as total_input_tokens,
        COALESCE(SUM(l.output_tokens), 0)::BIGINT as total_output_tokens,
        MAX(l.created_at) as last_used
    FROM ai_usage_logs l
    LEFT JOIN users u ON l.user_id = u.id
    WHERE l.created_at >= start_date 
      AND l.created_at <= end_date
    GROUP BY l.user_id, u.email
    ORDER BY total_cost DESC
    LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

### STEP 3: Update Frontend Dashboard

In the AI Usage Dashboard component (src/pages/admin/AIUsageDashboard.jsx or similar):

1. Add state for user data:

const [userUsage, setUserUsage] = useState([]);

2. Add API call in loadDashboardData function:

const userRes = await fetch(`/api/admin/ai-usage/by-user?user_id=${user.id}`);
const userData = await userRes.json();
setUserUsage(userData);

3. Add "Cost by User" section after "Cost by Service" section:

{/* Cost by User Section */}
<div className="bg-white rounded-lg border p-6 mt-6">
    <h2 className="text-lg font-semibold mb-4">ğŸ‘¤ Cost by User</h2>
    
    {userUsage.length === 0 ? (
        <p className="text-gray-500">No user data available</p>
    ) : (
        <div className="overflow-x-auto">
            <table className="w-full">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Requests</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tokens</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cost</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Used</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                    {userUsage.map((userRow, index) => (
                        <tr key={userRow.user_id || index} className="hover:bg-gray-50">
                            <td className="px-4 py-3 text-sm">
                                <div className="font-medium text-gray-900">
                                    {userRow.email || 'Unknown'}
                                </div>
                                <div className="text-xs text-gray-500">
                                    {userRow.user_id?.slice(0, 8)}...
                                </div>
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-600">
                                {userRow.total_requests || 0}
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-600">
                                {((userRow.total_input_tokens || 0) + (userRow.total_output_tokens || 0)).toLocaleString()}
                            </td>
                            <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                ${(userRow.total_cost || 0).toFixed(4)}
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-500">
                                {userRow.last_used 
                                    ? new Date(userRow.last_used).toLocaleDateString()
                                    : 'Never'
                                }
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    )}
</div>

### EXPECTED RESULT

The dashboard will show a new section:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ Cost by User                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User                â”‚ Requests â”‚ Tokens  â”‚ Cost    â”‚ Last Used â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  edoron777@gmail.com â”‚ 15       â”‚ 45,000  â”‚ $0.3500 â”‚ Dec 27    â”‚
â”‚  b7548590...         â”‚          â”‚         â”‚         â”‚           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  test1@gmail.com     â”‚ 3        â”‚ 8,500   â”‚ $0.0650 â”‚ Dec 26    â”‚
â”‚  02fe556a...         â”‚          â”‚         â”‚         â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### SUCCESS CHECKLIST
- [ ] SQL function created in Supabase
- [ ] Backend endpoint /api/admin/ai-usage/by-user works
- [ ] Frontend shows "Cost by User" section
- [ ] Table shows email, requests, tokens, cost, last used
- [ ] Data updates when date filter changes