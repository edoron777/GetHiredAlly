═══════════════════════════════════════════════════════════════
PROMPT 6#6: Integrate Scoring with CV Optimizer Service
═══════════════════════════════════════════════════════════════

⚠️ CRITICAL COMPLIANCE REQUIREMENTS ⚠️

1. Execute ONLY the instructions below - nothing more
2. Do NOT modify files not explicitly mentioned
3. Do NOT add features not explicitly requested
4. PRESERVE all existing functionality
5. If unclear, STOP and ask - do not assume

FORBIDDEN ACTIONS:
- Modifying the scoring module files
- Changing the AI prompt (already done)
- Breaking existing API endpoints
- Removing existing functionality

───────────────────────────────────────────────────────────────

TASK: Integrate the new scoring engine with the CV Optimizer service

OBJECTIVE:
Connect the new deterministic scoring to the existing CV Optimizer flow so that:
1. CV analysis uses the new scoring
2. Fixed CV is re-scored with the SAME algorithm
3. Score breakdown is stored in database

CONTEXT:
This is the final integration step. After this, the CV Optimizer will use deterministic scoring.

───────────────────────────────────────────────────────────────

INSTRUCTIONS:

Step 1: Find the main CV Optimizer service file (likely `server/services/cv_optimizer/cv_optimizer.py`)

Step 2: Add import for the new scoring module at the top:

```python
from common.scoring import calculate_cv_score
from common.scoring.calculator import get_score_message, calculate_improvement
```

Step 3: Find the function that analyzes CV and returns score. Update it to use the new scoring:

```python
def analyze_cv(cv_text: str) -> dict:
    """
    Analyze CV and calculate deterministic score.
    
    Flow:
    1. AI extracts structured data
    2. Code calculates score from data
    3. Return score + breakdown + issues
    """
    # Step 1: Extract data using AI
    extracted_data = extract_cv_data(cv_text)
    
    # Step 2: Calculate score using deterministic algorithm
    score_result = calculate_cv_score(extracted_data)
    
    # Step 3: Get user-friendly message
    message = get_score_message(score_result.total_score)
    
    return {
        'score': score_result.total_score,
        'breakdown': score_result.breakdown,
        'grade': score_result.grade,
        'grade_label': score_result.grade_label,
        'message': message,
        'issues': extracted_data.get('issues', []),
        'issues_count': score_result.issues_count,
        'auto_fixable_count': score_result.auto_fixable_count
    }
```

Step 4: Find the function that handles fixed CV scoring. Update it to RE-SCORE the fixed CV:

```python
def score_fixed_cv(original_cv: str, fixed_cv: str) -> dict:
    """
    Score the fixed CV using the SAME algorithm.
    
    CRITICAL: This ensures real improvement measurement.
    The fixed CV is re-analyzed and re-scored, not estimated.
    """
    # Score original CV
    original_data = extract_cv_data(original_cv)
    original_result = calculate_cv_score(original_data)
    
    # Score fixed CV (SAME algorithm!)
    fixed_data = extract_cv_data(fixed_cv)
    fixed_result = calculate_cv_score(fixed_data)
    
    # Calculate improvement
    improvement = calculate_improvement(
        original_result.total_score,
        fixed_result.total_score
    )
    
    return {
        'before_score': original_result.total_score,
        'after_score': fixed_result.total_score,
        'improvement_points': improvement['improvement_points'],
        'improvement_percent': improvement['improvement_percent'],
        'before_breakdown': original_result.breakdown,
        'after_breakdown': fixed_result.breakdown,
        'before_grade': original_result.grade_label,
        'after_grade': fixed_result.grade_label
    }
```

Step 5: Update the database save to include breakdown:

```python
# When saving CV analysis to database, include:
{
    'score': score_result.total_score,
    'score_breakdown': score_result.breakdown,  # JSON field
    'scoring_version': '4.0.0',
    'grade': score_result.grade
}
```

Step 6: Verify existing API endpoints still work:
- The response format should remain compatible
- Add breakdown to response if not already present

───────────────────────────────────────────────────────────────

FILES TO MODIFY:
- server/services/cv_optimizer/cv_optimizer.py (or main service file)

FILES TO CREATE:
- None

DO NOT TOUCH:
- server/common/scoring/* (already complete)
- server/services/cv_optimizer/cv_analyzer.py (already updated)
- Frontend files
- Database migration files

───────────────────────────────────────────────────────────────

WHEN COMPLETE:

Confirm these items:
□ Import added for scoring module
□ analyze_cv uses calculate_cv_score
□ Fixed CV scoring uses same algorithm
□ Score breakdown included in response
□ Existing API endpoints still work
□ No breaking changes to response format

CODE VERIFICATION:
Run these checks:
□ No syntax errors in modified file
□ All imports resolve correctly
□ Service starts without errors

Report:
- Which functions were modified
- Any compatibility concerns
- Any issues encountered